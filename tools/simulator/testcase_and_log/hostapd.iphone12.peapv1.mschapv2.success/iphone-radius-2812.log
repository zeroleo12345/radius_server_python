root@82157a8a69d7:/app/third_party/hostapd-2.10/hostapd# /app/bin/auth.sh 
当前项目目录: /app
PyMySQL==0.9.3
SQLAlchemy==1.3.11
certifi==2022.9.14
cffi==1.15.1
charset-normalizer==2.0.12
cryptography==3.2
dynaconf==3.1.2
gevent==22.10.2
greenlet==2.0.2
idna==3.6
loguru==0.5.3
netaddr==0.8.0
psutil==5.6.6
pycparser==2.21
python-dateutil==2.7.5
pytz==2019.1
redis==3.3.11
requests==2.27.0
sentry-sdk==0.8.0
six==1.15.0
urllib3==1.26.18
zope.event==5.0
zope.interface==6.1
2024-04-20 09:49:54.696 | INFO     | close log to file
2024-04-20 09:49:54.696 | INFO     | Log parameter. Level: DEBUG, Header: auth, Directory: 
2024-04-20 09:49:54.893 | INFO     | ## PEAP-MSCHAPV2 mode ##
2024-04-20 09:49:54.893 | INFO     | dicts directory: /app/etc/dictionary
2024-04-20 09:49:54.893 | DEBUG    | load dictionary: dictionary.microsoft
2024-04-20 09:49:54.893 | DEBUG    | load dictionary: dictionary.rfc3576
2024-04-20 09:49:54.893 | DEBUG    | load dictionary: dictionary.h3c
2024-04-20 09:49:54.893 | DEBUG    | load dictionary: dictionary.wispr
2024-04-20 09:49:54.893 | DEBUG    | ignore dictionary: README.md
2024-04-20 09:49:54.893 | DEBUG    | load dictionary: dictionary.pyrad
2024-04-20 09:49:54.898 | DEBUG    | listening on 0.0.0.0:1812
ca_cert_path: (/app/tools/simulator/etc/certs/ca.cer)
client_cert_path: (/app/tools/simulator/etc/certs/server.cer)
private_key_path: (/app/tools/simulator/etc/certs/server.key)
private_key_passwd: (123456)
dh_file_path: (/app/tools/simulator/etc/certs/dh)
py_authsrv_init success.
2024-04-20 09:50:07.100 | DEBUG    | outer_username: zhouliying, mac: 2A-54-F5-6E-47-36.previd: -1, recvid: 44.  prev_eapid: -1, recv_eapid: 1]
2024-04-20 09:50:07.100 | INFO     | peap auth. session_id: 68b8b44b-61b2-422c-8398-a27a487e67a7, call next_state: peap_challenge_start
2024-04-20 09:50:07.101 | DEBUG    | before PEAP Start, identity: zhouliying
2024-04-20 09:50:07.164 | DEBUG    | outer_username: zhouliying, mac: 2A-54-F5-6E-47-36.previd: 44, recvid: 45.  prev_eapid: 1, recv_eapid: 2]
2024-04-20 09:50:07.164 | INFO     | peap auth. session_id: 68b8b44b-61b2-422c-8398-a27a487e67a7, call next_state: peap_challenge_server_hello
2024-04-20 09:50:07.165 | DEBUG    | eap header, peap version: 1
2024-04-20 09:50:07.184 | DEBUG    | outer_username: zhouliying, mac: 2A-54-F5-6E-47-36.previd: 45, recvid: 46.  prev_eapid: 2, recv_eapid: 3]
2024-04-20 09:50:07.184 | INFO     | peap auth. session_id: 68b8b44b-61b2-422c-8398-a27a487e67a7, call next_state: peap_challenge_server_hello_fragment
2024-04-20 09:50:08.765 | DEBUG    | outer_username: zhouliying, mac: 2A-54-F5-6E-47-36.previd: 46, recvid: 47.  prev_eapid: 3, recv_eapid: 4]
2024-04-20 09:50:08.765 | INFO     | peap auth. session_id: 68b8b44b-61b2-422c-8398-a27a487e67a7, call next_state: peap_challenge_change_cipher_spec
2024-04-20 09:50:08.780 | DEBUG    | outer_username: zhouliying, mac: 2A-54-F5-6E-47-36.previd: 47, recvid: 48.  prev_eapid: 4, recv_eapid: 5]
2024-04-20 09:50:08.780 | INFO     | peap auth. session_id: 68b8b44b-61b2-422c-8398-a27a487e67a7, call next_state: peap_challenge_phase2_identity
2024-04-20 09:50:08.794 | DEBUG    | outer_username: zhouliying, mac: 2A-54-F5-6E-47-36.previd: 48, recvid: 49.  prev_eapid: 5, recv_eapid: 6]
2024-04-20 09:50:08.794 | INFO     | peap auth. session_id: 68b8b44b-61b2-422c-8398-a27a487e67a7, call next_state: peap_challenge_mschapv2_random
2024-04-20 09:50:08.830 | DEBUG    | outer_username: zhouliying, mac: 2A-54-F5-6E-47-36.previd: 49, recvid: 50.  prev_eapid: 6, recv_eapid: 7]
2024-04-20 09:50:08.830 | INFO     | peap auth. session_id: 68b8b44b-61b2-422c-8398-a27a487e67a7, call next_state: peap_challenge_mschapv2_nt
2024-04-20 09:50:08.845 | DEBUG    | outer_username: zhouliying, mac: 2A-54-F5-6E-47-36.previd: 50, recvid: 51.  prev_eapid: 7, recv_eapid: 8]
2024-04-20 09:50:08.845 | INFO     | peap auth. session_id: 68b8b44b-61b2-422c-8398-a27a487e67a7, call next_state: peap_challenge_success
2024-04-20 09:50:08.859 | DEBUG    | outer_username: zhouliying, mac: 2A-54-F5-6E-47-36.previd: 51, recvid: 52.  prev_eapid: 8, recv_eapid: 9]
2024-04-20 09:50:08.859 | INFO     | peap auth. session_id: 68b8b44b-61b2-422c-8398-a27a487e67a7, call next_state: peap_access_accept
2024-04-20 09:50:08.889 | CRITICAL | Traceback (most recent call last):
  File "/app/src/processor/auth_processor.py", line 60, in handle
    verify_user(request, auth_user)
  File "/app/src/processor/auth_processor.py", line 80, in verify_user
    return EapPeapMschapv2Flow.authenticate_handler(request=request, auth_user=auth_user)
  File "/app/src/auth/eap_peap_mschapv2_flow.py", line 48, in authenticate_handler
    cls.state_machine(request=request, eap=eap, peap=peap, session=session)
  File "/app/src/auth/eap_peap_mschapv2_flow.py", line 116, in state_machine
    return cls.peap_access_accept(request, eap, peap, session)    # end move
  File "/app/src/auth/eap_peap_mschapv2_flow.py", line 437, in peap_access_accept
    p_out_prf = libhostapd.call_tls_connection_prf(tls_connection=session.tls_connection, p_label=p_label)
  File "/app/src/library/crypto.py", line 112, in call_tls_connection_prf
    self.lib.tls_connection_prf.restype = ctypes.c_int    # 不加会导致 Segmentation fault
  File "/usr/local/lib/python3.7/ctypes/__init__.py", line 377, in __getattr__
    func = self.__getitem__(name)
  File "/usr/local/lib/python3.7/ctypes/__init__.py", line 382, in __getitem__
    func = self._FuncPtr((name_or_ordinal, self))
AttributeError: /app/lib/libhostapd.so: undefined symbol: tls_connection_prf

2024-04-20 09:50:08.990 | INFO     | OUT: reject|172.16.3.51|MSG360-20-xijie-26|EAP-PEAP-MSCHAPV2|zhouliying|2A-54-F5-6E-47-36|WIFI-3_5G|70-57-BF-90-54-00|system error|


# 定位原因
nm /app/lib/libhostapd.so  | grep tls_connection_prf
